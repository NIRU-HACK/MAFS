"""
Partition a dataset into 70% train, 20% validation, and 10% test.

Usage:
  python partition_dataset.py --images data/sar --annotations data/annotations --output data/partitioned
  python partition_dataset.py --images data/sar --annotations data/annotations --output data/partitioned --seed 42

Expects:
  - images/     : folder of images (e.g. .tiff, .png, .jpg)
  - annotations/: folder of YOLO-format .txt files (one per image, same base name)

Creates:
  - output/train/images, output/train/labels
  - output/val/images,   output/val/labels
  - output/test/images,  output/test/labels
  - output/dataset.yaml  (YOLO-style paths; edit 'path' if you move the dataset)
"""

import argparse
import os
import random
import shutil
from pathlib import Path


# Supported image extensions
IMAGE_EXTENSIONS = {".tiff", ".tif", ".png", ".jpg", ".jpeg", ".bmp"}


def get_image_basenames(images_dir: Path) -> list[str]:
    """Return sorted list of stem names (no extension) for all images in dir."""
    names = []
    for f in images_dir.iterdir():
        if f.is_file() and f.suffix.lower() in IMAGE_EXTENSIONS:
            names.append(f.stem)
    return sorted(names)


def partition_dataset(
    images_dir: Path,
    annotations_dir: Path,
    output_dir: Path,
    train_frac: float = 0.70,
    val_frac: float = 0.20,
    test_frac: float = 0.10,
    seed: int = 42,
) -> None:
    assert abs(train_frac + val_frac + test_frac - 1.0) < 1e-6, "Fractions must sum to 1.0"

    basenames = get_image_basenames(images_dir)
    if not basenames:
        raise FileNotFoundError(f"No images found in {images_dir}")

    random.seed(seed)
    random.shuffle(basenames)

    n = len(basenames)
    n_train = int(n * train_frac)
    n_val = int(n * val_frac)
    n_test = n - n_train - n_val

    train_names = set(basenames[:n_train])
    val_names = set(basenames[n_train : n_train + n_val])
    test_names = set(basenames[n_train + n_val :])

    splits = [
        ("train", train_names),
        ("val", val_names),
        ("test", test_names),
    ]

    for split_name, names in splits:
        img_out = output_dir / split_name / "images"
        lbl_out = output_dir / split_name / "labels"
        img_out.mkdir(parents=True, exist_ok=True)
        lbl_out.mkdir(parents=True, exist_ok=True)

        for stem in names:
            # Find image file (any supported extension)
            src_img = None
            for ext in IMAGE_EXTENSIONS:
                p = images_dir / f"{stem}{ext}"
                if p.exists():
                    src_img = p
                    break
            if src_img is None:
                continue
            shutil.copy2(src_img, img_out / src_img.name)

            # Copy annotation if present
            ann_path = annotations_dir / f"{stem}.txt"
            if ann_path.exists():
                shutil.copy2(ann_path, lbl_out / f"{stem}.txt")

    # Write YOLO-style dataset.yaml (path is relative to the yaml file)
    yaml_path = output_dir / "dataset.yaml"
    rel_path = output_dir.name  # e.g. "partitioned"
    yaml_content = f"""# MAFS dataset - 70/20/10 partition
# Generated by partition_dataset.py. Edit 'path' if you move the dataset.

path: {output_dir.absolute()}
train: train/images
val: val/images
test: test/images

# Number of classes; update names to match your labels
nc: 1
names: ['vessel']
"""

    yaml_path.write_text(yaml_content, encoding="utf-8")
    print(f"Partitioned {n} samples: train={n_train}, val={n_val}, test={n_test}")
    print(f"Output: {output_dir}")
    print(f"Dataset YAML: {yaml_path}")


def main():
    parser = argparse.ArgumentParser(description="Partition dataset 70/20/10 (train/val/test).")
    parser.add_argument("--images", type=Path, required=True, help="Folder containing images")
    parser.add_argument("--annotations", type=Path, required=True, help="Folder containing YOLO .txt labels")
    parser.add_argument("--output", type=Path, required=True, help="Output root (train/val/test created here)")
    parser.add_argument("--train", type=float, default=0.70, help="Train fraction (default 0.70)")
    parser.add_argument("--val", type=float, default=0.20, help="Validation fraction (default 0.20)")
    parser.add_argument("--test", type=float, default=0.10, help="Test fraction (default 0.10)")
    parser.add_argument("--seed", type=int, default=42, help="Random seed for reproducibility")
    args = parser.parse_args()

    partition_dataset(
        images_dir=args.images,
        annotations_dir=args.annotations,
        output_dir=args.output,
        train_frac=args.train,
        val_frac=args.val,
        test_frac=args.test,
        seed=args.seed,
    )


if __name__ == "__main__":
    main()
